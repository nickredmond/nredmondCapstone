package imageProcessing;

import java.awt.image.BufferedImage;

public class ImageScaler {
	public static BufferedImage scaleToHeight(int dimension, BufferedImage img){
        BufferedImage trimmedImg = trimImage(img);
		
		int newHeight = 0;
		int newWidth = 0;
		float scaleValue = 0.0f;
		
		if (trimmedImg.getHeight() > trimmedImg.getWidth()){
			newHeight = dimension;
			scaleValue = dimension / trimmedImg.getHeight();
			newWidth = (int) (trimmedImg.getWidth() * scaleValue);
		}
		else if (trimmedImg.getWidth() > trimmedImg.getHeight()){
			newWidth = dimension;
			scaleValue = dimension / trimmedImg.getWidth();
			newHeight = (int) (trimmedImg.getHeight() / dimension);
		}
		else{
			scaleValue = (dimension / trimmedImg.getHeight());
			newHeight = dimension;
			newWidth = dimension;
		}
		
        int startingX = (dimension - newWidth) / 2;
        int startingY = (dimension - newHeight) / 2;
        
        BufferedImage scaledImg = scaleToProperHeight(trimmedImg, scaleValue, dimension, startingX, startingY);
        
        for (int x = 0; x < startingX; x++){
            for (int y = 0; y < scaledImg.getHeight(); y++){
                    scaledImg.setRGB(x, y, NetworkIOTranslator.WHITE_RGB_VALUE);
            }
        }
    
	     for (int x = (startingX + newWidth + 1); x < scaledImg.getWidth(); x++){
            for (int y = 0; y < scaledImg.getHeight(); y++){
                    scaledImg.setRGB(x, y, NetworkIOTranslator.WHITE_RGB_VALUE);
            }
	     }
	     
	     for (int y = 0; y < startingY; y++){
	    	 for (int x = 0; x < scaledImg.getWidth(); x++){
	    		 scaledImg.setRGB(x, y, NetworkIOTranslator.WHITE_RGB_VALUE);
	    	 }
	     }
	     
	     for (int y = (startingY + newHeight + 1); y < scaledImg.getHeight(); y++){
	    	 for(int x = 0; x < scaledImg.getWidth(); x++){
	    		 scaledImg.setRGB(x, y, NetworkIOTranslator.WHITE_RGB_VALUE);
	    	 }
	     }
	     
	     return scaledImg;
	}
	
	private static BufferedImage trimImage(BufferedImage img){
		FeatureExtractionIOTranslator t = new FeatureExtractionIOTranslator();
		int[][] lightValues = t.getLightValues(img);
		
		int left = getLeft(lightValues);
		int right = getRight(lightValues);
		int top = getTop(lightValues);
		int bottom = getBottom(lightValues);
		
		right = (right == 0) ? img.getWidth() : right;
		bottom = (bottom == 0) ? img.getHeight() : bottom;
		
		left = (left == right) ? 0 : left;
		top = (top == bottom) ? 0 : top;
		
		return img.getSubimage(left, top, right - left, bottom - top);
	}
	
	private static int getLeft(int[][] img){
		int left = 0;
		boolean foundLeft = false;
		
		for (int x = 0; x < img[0].length && !foundLeft; x++){
			for (int y = 0; y < img.length && !foundLeft; y++){
				if (img[y][x] < NetworkIOTranslator.BLACK_RGB){
					left = x;
					foundLeft = true;
				}
			}
		}
		
		return left;
	}
	
	private static int getRight(int[][] img){
		int right = img[0].length;
		boolean foundRight = false;
		
		for (int x = img[0].length - 1; x >= 0 && !foundRight; x--){
			for (int y = 0; y < img.length && !foundRight; y++){
				if (img[y][x] < NetworkIOTranslator.BLACK_RGB){
					right = x;
					foundRight = true;
				}
			}
		}
		
		return right;
	}
	
	private static int getBottom(int[][] img){
		int bottom = img[0].length;
		boolean foundBottom = false;
		
		for (int y = img.length - 1; y >= 0 && !foundBottom; y--){
			for (int x = 0; x < img[0].length && !foundBottom; x++){
				if (img[y][x] < NetworkIOTranslator.BLACK_RGB){
					bottom = y;
					foundBottom = true;
				}
			}
		}
		
		return bottom;
	}
	
	private static int getTop(int[][] img){
		int top = 0;
		boolean foundTop = false;
		
		for (int y = 0; y < img.length && !foundTop; y++){
			for (int x = 0; x < img[0].length && !foundTop; x++){
				if (img[y][x] < NetworkIOTranslator.BLACK_RGB){
					top = y;
					foundTop = true;
				}
			}
		}
		
		return top;
	}
	
	private static boolean isValidPoint(int x, int y, BufferedImage img){
		return (x < img.getWidth() && y < img.getHeight());
	}
	
	private static BufferedImage scaleToProperHeight(BufferedImage img, float scaleValue, int dimension,
			int startingX, int startingY) {
		BufferedImage scaledImg = new BufferedImage(dimension, dimension, BufferedImage.TYPE_INT_RGB);
//		int currentScaledImgX = 0;
//		int currentScaledImgY = 0;
		
		for (int x = startingX; x < scaledImg.getWidth(); x++){
			for (int y = startingY; y < scaledImg.getHeight(); y++){
				float xRatio = ((float)x / (scaledImg.getWidth() - startingX));
				float yRatio = ((float)y / (scaledImg.getHeight() - startingY));
				int imageX = (int)(xRatio * img.getWidth());
				int imageY = (int)(yRatio * img.getHeight());
				
				if (isValidPoint(imageX, imageY, img)){
					scaledImg.setRGB(x, y, img.getRGB(imageX, imageY));
				}
			}
		}
		
//		for (float x = 0; x < img.getWidth(); x += scaleValue){
//			currentScaledImgY = 0;
//			
//			for (float y = 0; y < img.getHeight(); y += scaleValue){
//				int xPos = (int) x;
//				int yPos = (int) y;
//				
//				if (isValidPoint(currentScaledImgX, currentScaledImgY, scaledImg)){
//					scaledImg.setRGB(currentScaledImgX, currentScaledImgY, img.getRGB(xPos, yPos));
//				}
//				
//				currentScaledImgY++;
//			}
//			currentScaledImgX++;
//		}
		return scaledImg;
	}
}
